<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Key Generator & Tracker</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, set, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth();
    const db = getDatabase();

    // Helper functions
    function extractURLParts() {
      const path = window.location.pathname.split('/').filter(Boolean);
      if (path.length === 2 && path[0].startsWith('KEY-')) {
        return { key: path[0], userId: path[1] };
      }
      return null;
    }

    function displayLink(key, userId) {
      const link = `https://sawutser.top/${key}/${userId}`;
      document.getElementById('share-link').href = link;
      document.getElementById('share-link').innerText = link;
    }

    function updateClickCountUI(count) {
      document.getElementById('click-count').innerText = `This link has been visited ${count} times.`;
    }

    function trackClickIfSharedLink() {
      const parts = extractURLParts();
      if (parts) {
        const keyRef = ref(db, 'keys/' + parts.key);
        get(keyRef).then(snapshot => {
          if (snapshot.exists()) {
            const data = snapshot.val();
            const newCount = (data.clicks || 0) + 1;
            update(keyRef, { clicks: newCount }).then(() => {
              updateClickCountUI(newCount);
            });
          } else {
            document.getElementById('click-count').innerText = 'Invalid key.';
          }
        });
      }
    }

    function getClickCount(key) {
      const keyRef = ref(db, 'keys/' + key);
      get(keyRef).then(snapshot => {
        if (snapshot.exists()) {
          const clickCount = snapshot.val().clicks || 0;
          updateClickCountUI(clickCount);
        }
      });
    }

    // MAIN FLOW
    signInAnonymously(auth).then(() => {
      const userId = auth.currentUser.uid;
      const parts = extractURLParts();

      if (parts) {
        // Visitor of shared link → only track click
        document.getElementById('generator-section').style.display = 'none';
        trackClickIfSharedLink();
      } else {
        // User on app → key generation
        const userRef = ref(db, 'users/' + userId);
        get(userRef).then(snapshot => {
          if (snapshot.exists()) {
            const key = snapshot.val().key;
            document.getElementById('status').innerText = 'Your unique key: ' + key;
            displayLink(key, userId);
            getClickCount(key);
          }
        });

        document.getElementById('generateKeyButton').addEventListener('click', () => {
          get(userRef).then(snapshot => {
            if (snapshot.exists()) {
              const key = snapshot.val().key;
              alert('You already have a key: ' + key);
              document.getElementById('status').innerText = 'Your unique key: ' + key;
              displayLink(key, userId);
              getClickCount(key);
            } else {
              const newKey = 'KEY-' + Math.random().toString(36).substr(2, 9);
              const keyRef = ref(db, 'keys/' + newKey);
              set(keyRef, { createdBy: userId, clicks: 0 }).then(() => {
                set(userRef, { key: newKey }).then(() => {
                  document.getElementById('status').innerText = 'Your unique key: ' + newKey;
                  displayLink(newKey, userId);
                  updateClickCountUI(0);
                });
              });
            }
          });
        });
      }
    });
  </script>
</head>

<body>
  <h1>Key Generator & Tracker</h1>

  <div id="generator-section">
    <p id="status">Click below to generate your unique key.</p>
    <button id="generateKeyButton">Generate Unique Key</button>
    <p>Share this link:</p>
    <a id="share-link" href="#" target="_blank">Link will appear here</a>
  </div>

  <p id="click-count">Click count will appear here.</p>

</body>
</html>